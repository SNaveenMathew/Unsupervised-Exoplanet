---
title: "Exoplanet Candidate Dashboard"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r global, include = FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
# reticulate::use_condaenv("tf_gpu")
# library(shinyauthr)
# library(keras)
# library(kerasR)
library(png)
library(grid)
library(RSQLite)
library(shinydashboard)
library(glue)
library(readr)
library(imputeTS)
source("../util.R")

return_stars <- function(processed) {
  processed <- strsplit(processed, "_")
  processed <- unique(sapply(processed, function(filename) filename[1]))
  return(processed)
}

processed <- list.files("../plots/test_pred_plot/", full.names = F)
processed <- return_stars(processed)
all_stars <- list.files("../data/", pattern = ".tbl", full.names = F)
all_stars <- return_stars(all_stars)
remaining <- setdiff(all_stars, processed)
train_ratio <- 0.7


sql_db_file <- "../exoplanet_db.sqlite"
mydb <- dbConnect(RSQLite::SQLite(), sql_db_file)
if(!dbExistsTable(conn = mydb, name = "user_star")) {
dbGetQuery(mydb, "CREATE TABLE user_star (user_id varchar(64), kepler_id int, start int, end int);")
}
dbDisconnect(mydb)


user_base <- data.frame(
  user = c("user1", "user2"),
  password = c("pass1", "pass2"), 
  password_hash = sapply(c("pass1", "pass2"), sodium::password_store), 
  permissions = c("admin", "standard"),
  name = c("User One", "User Two")
)



int1 <- length(processed)
style_text <- paste0("
        #kplr_id ~ .selectize-control .option:nth-child(-n+",
        as.character(int1),
        ") {
          background-color: rgba(0,255,0,1);

        }

        #kplr_id ~ .selectize-control .option:nth-child(n+",
        as.character(int1 + 1),
        ") {
          background-color: rgba(255,0,0,1);
        }
")
options <- c(processed, remaining)
```

```{r}
shinyApp(ui = dashboardPage(
  dashboardHeader(
    title = "Exoplanet Candidates Page",
    tags$li(class = "dropdown", style = "padding: 8px;",
            shinyauthr::logoutUI("logout")),
    tags$li(
      class = "dropdown", 
      tags$a(icon("github"), 
             href = "https://github.com/SNaveenMathew/Unsupervised-Exoplanet",
             title = "See the code on github"))),
  
  dashboardSidebar(collapsed = T,
    div(textOutput("welcome"), style = "padding: 20px"),
    div(uiOutput("kplr_id"))
  ),
  
  dashboardBody(
    shinyjs::useShinyjs(),
    shinyauthr::loginUI("login"),
    tags$head(
      tags$style(style_text)
    ),
    uiOutput("planet_page")
  )
),

server = function(input, output) {
  logout_init <- callModule(shinyauthr::logout, "logout",
                            reactive(credentials()$user_auth))
  
  credentials <- callModule(shinyauthr::login, "login", 
                            data = user_base,
                            user_col = user,
                            pwd_col = password_hash,
                            sodium_hashed = TRUE,
                            log_out = reactive(logout_init()))
  
  observe({
    if(credentials()$user_auth) {
      shinyjs::removeClass(selector = "body", class = "sidebar-collapse")
    } else {
      shinyjs::addClass(selector = "body", class = "sidebar-collapse")
    }
  })
  
  output$kplr_id <- renderUI({
    if(credentials()$user_auth) {
      return(selectInput(inputId = "kplr_id", label = "Select Kepler ID:",
                         choices = options, selected = options[1]))
    }
  })
  
  starts_ends <- reactive({
    starts <- c()
    ends <- c()
    mydb <- dbConnect(RSQLite::SQLite(), sql_db_file)
    username <- user_info()$name
    id <- input$kplr_id
    id <- as.integer(gsub(strsplit(id, "_")[[1]][1],
                          pattern = "kplr", replacement = ""))
    query <- paste0("SELECT * FROM user_star WHERE user_id='", username,
                    "' AND kepler_id=", id, ";")
    query_result <- dbGetQuery(mydb, query)
    print(query)
    if(nrow(query_result) == 0) {
      mydb <- dbConnect(RSQLite::SQLite(), sql_db_file)
      query <- paste0("SELECT * FROM test_idx WHERE id=", id, ";")
      print(query)
      query_result <- dbGetQuery(mydb, query)
      if(nrow(query_result) > 0) {
        starts <- query_result$start
        ends <- query_result$end
      } else {
        starts <- 0
        ends <- 0
      }
    }
    dbDisconnect(mydb)
    return(list(starts = starts, ends = ends))
  })
  
  get_data <- reactive({
    starts_ends <- starts_ends()
    # print(starts_ends)
    if(!credentials()$user_auth) return(NULL)
    file <- list.files("../data/", pattern = input$kplr_id, full.names = T)
    file <- file[1]
    print(file)
    wave <- get_wave(file, impute = F)
    idx <- 1:floor(train_ratio * length(wave))
    train <- wave[idx]
    test <- wave[-idx]
    # temp_png <- png("temp_png.png", width = 1366, height = 768)
    idx <- rep(FALSE, length(test))
    if(length(starts_ends$starts) > 1) {
      indices <- unlist(lapply(1:length(starts_ends$starts), function(i)
        starts_ends$starts[i]:starts_ends$ends[i]))
      idx[indices] <- T
    }
    return(list(test = test, idx = idx))
  })
  
  getImage <- reactive({
    reqd_data <- get_data()
    return(plot(reqd_data$test, col = reqd_data$idx + 1))
  })
  
  output$trainPlot <- renderPlot({
    return(getImage())
  })
  
  user_info <- reactive({
    return(credentials()$info)
  })
  
  output$welcome <- renderText({
    req(credentials()$user_auth)
    return(glue("Welcome {user_info()$name}"))
  })
  
  observeEvent(input$customize, {
    username <- user_info()$name
    print(username)
    mydb <- dbConnect(RSQLite::SQLite(), sql_db_file)
    id <- as.integer(gsub(strsplit(input$kplr_id, "_")[[1]][1],
                          pattern = "kplr", replacement = ""))
    delete_query <- paste0("DELETE FROM user_star WHERE user_id='", username,
                           "' AND kepler_id=", id)
    dbGetQuery(mydb, delete_query)
    insert_query <- paste0("INSERT INTO user_star VALUES ('", username,
                           "', ", id, ", 0, 0);")
    dbExecute(mydb, insert_query)
    dbDisconnect(mydb)
    output$trainPlot <- renderPlot({
      return(getImage())
    })
  })
  
  observeEvent(input$reset, {
    username <- user_info()$name
    print(username)
    mydb <- dbConnect(RSQLite::SQLite(), sql_db_file)
    id <- as.integer(gsub(strsplit(input$kplr_id, "_")[[1]][1],
                          pattern = "kplr", replacement = ""))
    delete_query <- paste0("DELETE FROM user_star WHERE user_id='", username,
                           "' AND kepler_id=", id)
    dbGetQuery(mydb, delete_query)
    dbDisconnect(mydb)
    output$trainPlot <- renderPlot({
      return(getImage())
    })
  })
  
  output$planet_page <- renderUI({
    req(credentials()$user_auth)
    return(fluidPage(
      fluidRow(plotOutput("trainPlot", brush = brushOpts(id = "trainPlot_brush",
                                                         direction = 'x')),
               actionButton("customize", "Customize"),
               actionButton("reset", "Reset to default"))
    ))
  })
})

```
